通讯双方经过三次握手成功建立了 tcp链接，如果此时任意一方因为断电或者其他原因意外崩溃了，那么另一方该如何处理这种情况？

是会一直保持这个链接直至系统重启？还是会等待一段时间后超时自动断开链接？tcp协议是如何规定这种情况的？


正文
断电、死机、重启，意味着所有状态信息的丢失，如同一个失忆的人，对外界的一切是陌生的，即使重新启动、程序正常运行也是如此。

另一方肯定还是有正常记忆的，但双方状态（记忆）不对称已经无法完成正常意义的沟通，所以最好的方法，就是让好的一方检测到记忆的不对称，然后把自己的记忆也释放（reset)，双方再重新谈一场恋爱（TCP重连）。

好的一方如何检测呢？

TCP Keepalive
默认情况下，TCP 120分钟会发送检测信号，如果对方没有回复，会重试几次到放弃，然后宣布对方翘辫子，发送Reset释放连接。

对方收到会莫名其妙，会默默地忽视，因为压根没有这个连接（掉电释放掉了）。

2个小时是一个漫长的等待，滞留的TCP会话会一直占用资源，这是一种浪费！


Application Keepalive
为了更快地检测对方已经Dead的事实，应用程序层面可以发送检测信号，比如5-10分钟检测一次。

通过以上两种常用方法，可以克服好的一方永久驻留在内存里的现状，释放是唯一正确的方法！

其实，Application Keepalive除了检测对方是否在线，最大的作用是为了避免存在于通信双方之间的NAT设备表超时删除，需要周期性地刷新保活！


问题来了，如果不保活，NAT表被删除了，即使双方都没有重启，它们还能正常通信吗？

当然不能了，NAT表都没有了，没法通信！

原文：https://mp.weixin.qq.com/s/HJvLojnZiXUVvBr9Sar53g
